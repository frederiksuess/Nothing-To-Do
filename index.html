<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="N·OS">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192x192.png">
<title>N·OS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async></script>
<style>
:root{
  --bg:#000;--s1:rgba(10,10,10,0.85);--s2:rgba(17,17,17,0.85);--b1:#1a1a1a;--b2:#2a2a2a;
  --red:#D71921;--rs:rgba(215,25,33,.15);
  --w:#fff;--w70:rgba(255,255,255,.75);--w40:rgba(255,255,255,.45);
  --w20:rgba(255,255,255,.20);--w10:rgba(255,255,255,.10);--w05:rgba(255,255,255,.05);
  --mono:'Space Mono',monospace;--sans:'DM Sans',-apple-system,sans-serif;
  --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px);
  --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}

/* Dot Matrix Background for true Nothing OS feel */
html,body{height:100%;background-color:var(--bg);background-image:radial-gradient(var(--w05) 1px,transparent 1px);background-size:24px 24px;color:var(--w);font-family:var(--sans);overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overscroll-behavior:none;}

button{cursor:pointer;border:none;background:none;color:inherit;font:inherit;transition:transform .15s var(--ease), opacity .15s;}
input,textarea{font:inherit;color:inherit;background:none;border:none;outline:none;}
textarea{resize:none;}
::selection{background:rgba(215,25,33,.4);color:#fff;}

/* ── SHELL ── */
#app{position:fixed;inset:0;padding-top:var(--sat);padding-bottom:var(--sab);display:flex;flex-direction:column;}

/* ── HEADER ── */
#hdr{flex-shrink:0;display:flex;align-items:center;padding:0 20px;height:56px;border-bottom:1px solid var(--w05);background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:100;}
#logo{font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:6px;color:var(--w40);flex:1;}
#logo b{color:var(--red);text-shadow:0 0 8px rgba(215,25,33,0.6);}
#sync-dot{width:6px;height:6px;border-radius:50%;background:var(--b2);margin-right:16px;flex-shrink:0;transition:background .4s, box-shadow .4s;}
#sync-dot.on{background:#3ddc84;box-shadow:0 0 8px rgba(61,220,132,0.4);}
#sync-dot.busy{background:var(--red);box-shadow:0 0 8px rgba(215,25,33,0.5);animation:pulse .8s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}
#hdr-drv{width:36px;height:36px;border-radius:50%;border:1px solid var(--w10);display:flex;align-items:center;justify-content:center;color:var(--w40);transition:background .2s, color .2s;}
#hdr-drv:active{background:var(--w10);color:var(--w);transform:scale(0.92);}

/* ── TABS ── */
#tabs{flex-shrink:0;display:flex;border-bottom:1px solid var(--w05);padding:0 4px;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);}
.tab{position:relative;flex:1;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--w20);padding:14px 0 12px;transition:color .25s var(--ease);}
.tab::after{content:'';position:absolute;bottom:0;left:50%;width:0;height:2px;background:var(--red);transition:width .3s var(--ease), left .3s var(--ease), box-shadow .3s;}
.tab.on{color:var(--w);}
.tab.on::after{width:40%;left:30%;box-shadow:0 -1px 8px rgba(215,25,33,0.6);}

/* ── PANELS ── */
.panel{flex:1;overflow:hidden;display:none;flex-direction:column;position:relative;animation:fadeIn .3s var(--ease);}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.panel.on{display:flex;}
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;}
.scroll::-webkit-scrollbar{display:none;}

/* ── TODO ITEMS ── */
.td{display:flex;align-items:flex-start;padding:16px 20px;border-bottom:1px solid var(--w05);gap:14px;cursor:pointer;user-select:none;transition:background .2s, transform .2s var(--ease);}
.td:active{background:var(--w05);transform:scale(0.98);}
.ck{flex-shrink:0;width:22px;height:22px;border-radius:50%;border:1.5px solid var(--w20);display:flex;align-items:center;justify-content:center;margin-top:1px;transition:border-color .3s,background .3s, transform .2s;}
.td:active .ck{transform:scale(0.9);}
.ck svg{opacity:0;transition:opacity .2s, transform .3s cubic-bezier(0.34, 1.56, 0.64, 1); transform:scale(0.5); width:12px;height:12px;}
.td.done .ck{background:rgba(255,255,255,0.08);border-color:transparent;}
.td.done .ck svg{opacity:1; transform:scale(1);}
.td-body{flex:1;min-width:0;}
.td-text{font-size:15px;color:var(--w70);line-height:1.45;letter-spacing:-0.2px;word-break:break-word;transition:color .3s, text-decoration .3s;}
.td.done .td-text{text-decoration:line-through;color:var(--w20);}
.td-focus-dot{width:6px;height:6px;border-radius:50%;background:var(--red);flex-shrink:0;margin-top:9px;box-shadow:0 0 6px rgba(215,25,33,0.8);}
.td-btns{display:flex;flex-shrink:0;gap:4px;opacity:0;transform:translateX(10px);transition:opacity .25s var(--ease), transform .25s var(--ease);}
.td:active .td-btns, .td:hover .td-btns{opacity:1;transform:translateX(0);}
@media(hover:none){.td-btns{opacity:1;transform:translateX(0);}}
.tb{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--w20);background:var(--w05);}
.tb:active{color:var(--w);background:var(--w10);transform:scale(0.85);}
.tb.foc-on{color:var(--red);background:var(--rs);}
.cat-pill{display:inline-block;font-family:var(--mono);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--w40);background:var(--w05);border-radius:4px;padding:4px 8px;margin-top:8px;}

/* ── EMPTY ── */
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:40px;opacity:0.6;animation:fadeIn .5s var(--ease);}
.empty-ring{width:40px;height:40px;border-radius:50%;border:2px dashed var(--w10);animation:spin 10s linear infinite;}
@keyframes spin{100%{transform:rotate(360deg);}}
.empty-txt{font-family:var(--mono);font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--w40);text-align:center;line-height:1.8;}

/* ── FAB ── */
#fab-wrap{position:fixed;bottom:calc(28px + var(--sab));right:24px;z-index:200;display:flex;flex-direction:column;align-items:flex-end;gap:14px;}
#fab{width:56px;height:56px;border-radius:50%;background:var(--red);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(215,25,33,0.4);transition:transform .3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow .3s, opacity .2s;}
#fab.open{transform:rotate(135deg);box-shadow:0 4px 12px rgba(215,25,33,0.2);}
#fab:active{transform:scale(0.85) !important;}
.fab-item{display:flex;align-items:center;gap:12px;opacity:0;pointer-events:none;transform:translateY(16px) scale(0.9);transition:opacity .2s var(--ease), transform .2s var(--ease);}
.fab-item.on{opacity:1;pointer-events:auto;transform:translateY(0) scale(1);}
.fab-item:nth-child(1){transition-delay:.06s;}
.fab-item:nth-child(2){transition-delay:.03s;}
.fab-item:nth-child(3){transition-delay:0s;}
.fab-lbl{font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--w70);background:rgba(20,20,20,0.8);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--w10);border-radius:8px;padding:8px 16px;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.fab-ico{width:48px;height:48px;border-radius:50%;background:rgba(20,20,20,0.8);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--w10);display:flex;align-items:center;justify-content:center;color:var(--w70);box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.fab-ico:active{transform:scale(0.85);background:var(--w10);}

/* ── ADD SHEET / MODALS ── */
#add-sheet-ov, #drv-ov{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:none;align-items:flex-end;opacity:0;transition:opacity .25s var(--ease);}
#add-sheet-ov.on, #drv-ov.on{display:flex;opacity:1;}
#add-sheet, #drv-sh{width:100%;background:linear-gradient(180deg, var(--s2) 0%, #000 100%);border-top:1px solid var(--w10);border-radius:24px 24px 0 0;padding:24px 24px calc(24px + var(--sab));box-shadow:0 -10px 40px rgba(0,0,0,0.5);transform:translateY(100%);transition:transform .35s cubic-bezier(0.2, 0.8, 0.2, 1);}
#add-sheet-ov.on #add-sheet, #drv-ov.on #drv-sh{transform:translateY(0);}

.ash-handle{width:40px;height:4px;background:var(--w20);border-radius:2px;margin:0 auto 24px;}
.ash-title{font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--w40);margin-bottom:16px;}
#ash-input{width:100%;font-size:18px;color:var(--w);caret-color:var(--red);padding:8px 0 16px;border-bottom:1px solid var(--w20);margin-bottom:20px;transition:border-color .2s;}
#ash-input:focus{border-bottom-color:var(--red);}
#ash-input::placeholder{color:var(--w20);}

.ash-focus-toggle{display:flex;align-items:center;justify-content:space-between;padding:12px 0 24px;}
.ash-focus-label{font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--w40);}
.ash-toggle{width:44px;height:24px;border-radius:100px;background:var(--w10);border:1px solid transparent;position:relative;transition:background .2s, border-color .2s;}
.ash-toggle.on{background:var(--red);box-shadow:0 0 12px rgba(215,25,33,0.4);}
.ash-toggle::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow .2s;}
.ash-toggle.on::after{transform:translateX(20px);box-shadow:0 2px 4px rgba(0,0,0,0.3);}

.ash-submit{width:100%;padding:16px;border-radius:12px;background:var(--red);font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#fff;box-shadow:0 8px 24px rgba(215,25,33,0.3);transition:transform .15s, opacity .15s;}
.ash-submit:active{transform:scale(0.97);opacity:.9;}

/* ── FOCUS PANEL ── */
.pomo-wrap{display:flex;flex-direction:column;align-items:center;padding:32px 20px 24px;border-bottom:1px solid var(--w05);}
.pomo-ring-wrap{position:relative;width:180px;height:180px;margin-bottom:24px;}
.pomo-svg{width:180px;height:180px;transform:rotate(-90deg);}
.pr-bg{fill:none;stroke:var(--w05);stroke-width:2;}
.pr-fg{fill:none;stroke:var(--red);stroke-width:3;stroke-linecap:round;filter:drop-shadow(0 0 10px rgba(215,25,33,0.6));transition:stroke-dashoffset .5s linear, stroke .3s;}
.pomo-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;}
.pomo-digits{font-family:var(--mono);font-size:42px;font-weight:700;letter-spacing:2px;color:var(--w);}
.pomo-lbl{font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:var(--w40);}
.pomo-rounds{display:flex;gap:8px;margin-bottom:24px;}
.pr-dot{width:8px;height:8px;border-radius:50%;background:var(--w10);transition:background .3s, box-shadow .3s, transform .3s cubic-bezier(0.34, 1.56, 0.64, 1);}
.pr-dot.done{background:var(--red);box-shadow:0 0 8px rgba(215,25,33,0.6);transform:scale(1.2);}
.pomo-btns{display:flex;gap:20px;align-items:center;margin-bottom:24px;}
.pomo-btn{width:52px;height:52px;border-radius:50%;background:var(--w05);display:flex;align-items:center;justify-content:center;color:var(--w40);transition:transform .15s, color .2s, background .2s;}
.pomo-btn:active{transform:scale(0.85);background:var(--w10);color:var(--w);}
.pomo-btn.primary{width:64px;height:64px;background:var(--red);color:var(--w);box-shadow:0 8px 24px rgba(215,25,33,0.4);}
.pomo-btn.primary:active{background:#b8141b;}
.pomo-btn.primary svg{width:20px;height:20px;}

.pomo-notify{display:flex;align-items:center;gap:12px;background:var(--w05);padding:8px 16px;border-radius:100px;border:1px solid var(--w05);}
.pomo-notify-lbl{font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--w40);}

.ftask{display:flex;align-items:center;padding:16px 20px;border-bottom:1px solid var(--w05);gap:14px;cursor:pointer;transition:background .2s, transform .2s var(--ease);}
.ftask:active{background:var(--w05);transform:scale(0.98);}
.ftask.done .ftxt{text-decoration:line-through;color:var(--w20);}
.ftxt{flex:1;font-size:15px;color:var(--w70);letter-spacing:-0.2px;}
.fcat{font-family:var(--mono);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--w20);background:var(--w05);padding:4px 8px;border-radius:4px;}

/* ── NOTES ── */
.note-row{padding:18px 20px;border-bottom:1px solid var(--w05);cursor:pointer;transition:background .2s, transform .2s var(--ease);}
.note-row:active{background:var(--w05);transform:scale(0.98);}
.note-ttl{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--w);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.note-prv{font-size:14px;color:var(--w40);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:8px;line-height:1.4;}
.note-dt{font-family:var(--mono);font-size:10px;color:var(--w20);letter-spacing:1px;}

#note-search-bar{flex-shrink:0;display:flex;align-items:center;padding:12px 20px;border-bottom:1px solid var(--w10);background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);gap:12px;}
#note-search-bar svg{color:var(--w40);flex-shrink:0;}
#note-search{flex:1;font-size:15px;color:var(--w);caret-color:var(--red);}
#note-search::placeholder{color:var(--w40);}

/* ── NOTE EDITOR ── */
#ed{position:fixed;inset:0;padding-top:var(--sat);background:var(--bg);background-image:radial-gradient(var(--w05) 1px,transparent 1px);background-size:24px 24px;display:flex;flex-direction:column;z-index:400;transform:translateX(100%);transition:transform .35s var(--ease);}
#ed.open{transform:translateX(0);}
#ed-nav{flex-shrink:0;display:flex;align-items:center;padding:0 16px;height:56px;border-bottom:1px solid var(--w05);background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);gap:6px;}
#ed-back{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--w40);padding:8px;transition:color .2s, transform .2s;}
#ed-back:active{color:var(--w);transform:translateX(-4px);}
#ed-mode-toggle{margin-left:auto;display:flex;background:var(--w05);border-radius:100px;padding:4px;}
.ed-mode-btn{font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:6px 12px;border-radius:100px;color:var(--w40);transition:background .2s,color .2s;}
.ed-mode-btn.on{background:var(--w10);color:var(--w);}
#ed-del{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--w40);margin-left:6px;transition:color .2s, background .2s;}
#ed-del:active{color:var(--red);background:var(--rs);}

#ed-title-wrap{flex-shrink:0;padding:16px 20px 12px;border-bottom:1px solid var(--w05);}
#ed-title{font-family:var(--mono);font-size:20px;font-weight:700;letter-spacing:-0.5px;caret-color:var(--red);color:var(--w);width:100%;}
#ed-title::placeholder{color:var(--w20);}
#ed-tb{flex-shrink:0;display:flex;align-items:center;padding:6px 12px;gap:4px;border-bottom:1px solid var(--w05);overflow-x:auto;}
#ed-tb::-webkit-scrollbar{display:none;}
.tbb{flex-shrink:0;width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:700;color:var(--w40);background:var(--w05);transition:background .2s, color .2s, transform .1s;}
.tbb:active{color:var(--w);background:var(--w10);transform:scale(0.9);}

#ed-body{flex:1;position:relative;overflow:hidden;}
#ed-ta{position:absolute;inset:0;font-family:var(--mono);font-size:14px;line-height:1.9;color:var(--w70);caret-color:var(--red);padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch;white-space:pre-wrap;word-break:break-word;}
#ed-ta::placeholder{color:var(--w20);}
#ed-prev{position:absolute;inset:0;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;font-size:15px;line-height:1.8;color:var(--w70);display:none;z-index:2;}
#ed-prev.on{display:block;}

/* MD Styling refined */
#ed-prev h1{font-family:var(--mono);font-size:22px;color:var(--w);margin:1.2em 0 .5em;padding-bottom:8px;border-bottom:1px solid var(--w10);}
#ed-prev h2{font-family:var(--mono);font-size:18px;color:var(--w);margin:1em 0 .4em;}
#ed-prev h3{font-family:var(--mono);font-size:15px;color:var(--w70);margin:.8em 0 .3em;}
#ed-prev p{margin:.6em 0;}
#ed-prev strong{color:var(--w);font-weight:500;}
#ed-prev code{font-family:var(--mono);font-size:13px;background:var(--w05);padding:2px 6px;border-radius:4px;color:var(--red);}
#ed-prev pre{background:var(--w05);padding:16px;border-radius:8px;margin:1em 0;overflow-x:auto;border:1px solid var(--w10);}
#ed-prev pre code{background:none;padding:0;color:var(--w70);}
#ed-prev blockquote{border-left:3px solid var(--red);padding-left:16px;color:var(--w40);margin:1em 0;font-style:italic;}
#ed-prev hr{border:none;border-top:1px dashed var(--w20);margin:1.5em 0;}
#ed-prev a.wl{color:var(--red);border-bottom:1px dotted var(--red);cursor:pointer;text-decoration:none;font-family:var(--mono);transition:opacity .2s;}
#ed-prev a.wl:active{opacity:0.6;}
#ed-prev a.wl.new{color:var(--w40);border-bottom-color:var(--w20);}

#ed-bl{flex-shrink:0;border-top:1px solid var(--w10);background:rgba(0,0,0,0.5);display:none;padding-bottom:var(--sab);}
#ed-bl.on{display:block;}
.bl-hd{font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--w40);padding:12px 20px 8px;}
.bl-row{padding:10px 20px;font-size:14px;color:var(--w40);cursor:pointer;display:flex;align-items:center;gap:12px;transition:background .2s, color .2s;}
.bl-row::before{content:'←';color:var(--red);font-family:var(--mono);font-size:12px;}
.bl-row:active{color:var(--w);background:var(--w05);}

/* ── AUTOCOMPLETE & TOAST ── */
#ac{position:fixed;background:rgba(20,20,20,0.9);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--w10);border-radius:12px;z-index:800;min-width:220px;max-width:320px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.8);display:none;}
#ac.on{display:block;animation:fadeIn .2s var(--ease);}
#ac-hd{padding:10px 16px;font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--w40);border-bottom:1px solid var(--w10);}
.ac-row{padding:12px 16px;font-family:var(--mono);font-size:13px;color:var(--w70);display:flex;align-items:center;gap:10px;cursor:pointer;transition:background .2s, color .2s;}
.ac-row.sel,.ac-row:active{background:var(--w10);color:var(--w);}

#toast{position:fixed;bottom:calc(100px + var(--sab));left:50%;transform:translateX(-50%) translateY(20px) scale(0.9);background:rgba(30,30,30,0.9);backdrop-filter:blur(12px);border:1px solid var(--w10);border-radius:100px;padding:10px 20px;font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--w);white-space:nowrap;opacity:0;transition:opacity .3s var(--ease), transform .3s var(--ease);pointer-events:none;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,0.5);}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0) scale(1);}

/* Drive Modal adjustments */
#ds-input{width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--w20);border-radius:12px;padding:14px;font-family:var(--mono);font-size:12px;color:var(--w);caret-color:var(--red);margin-bottom:20px;transition:border-color .2s;}
#ds-input:focus{border-color:var(--red);}
.sh-btns{display:flex;gap:12px;}
.sh-btn{flex:1;padding:14px;border-radius:12px;background:var(--w05);font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--w70);transition:transform .15s, background .2s;}
.sh-btn:active{transform:scale(0.96);background:var(--w10);}
.sh-btn.primary{background:var(--red);color:#fff;box-shadow:0 8px 24px rgba(215,25,33,0.3);}
.sh-btn.primary:active{background:#b8141b;}
</style>
</head>
<body>
<div id="app">

  <div id="hdr">
    <div id="logo">N<b>·</b>OS</div>
    <div id="sync-dot"></div>
    <button id="hdr-drv" onclick="openDrv()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    </button>
  </div>

  <div id="tabs">
    <button class="tab on" id="tab-fokus"    onclick="goTab('fokus')">Fokus</button>
    <button class="tab"    id="tab-aufgaben" onclick="goTab('aufgaben')">Aufgaben</button>
    <button class="tab"    id="tab-notizen"  onclick="goTab('notizen')">Notizen</button>
  </div>

  <div class="panel on" id="panel-fokus">
    <div class="scroll" id="fokus-scroll">
      <div class="pomo-wrap">
        <div class="pomo-ring-wrap">
          <svg class="pomo-svg" viewBox="0 0 180 180">
            <circle class="pr-bg" cx="90" cy="90" r="82"/>
            <circle class="pr-fg" id="pomo-arc" cx="90" cy="90" r="82" stroke-dasharray="515.22" stroke-dashoffset="0"/>
          </svg>
          <div class="pomo-inner">
            <div class="pomo-digits" id="pomo-time">25:00</div>
            <div class="pomo-lbl" id="pomo-mode">FOKUS</div>
          </div>
        </div>
        <div class="pomo-rounds" id="pomo-rounds"></div>
        <div class="pomo-btns">
          <button class="pomo-btn" onclick="pomoCycle(-1)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
          </button>
          <button class="pomo-btn primary" onclick="pomoToggle()">
            <svg id="ico-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 4 20 12 6 20 6 4"/></svg>
            <svg id="ico-pause" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
          </button>
          <button class="pomo-btn" onclick="pomoSkip()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="5 12 19 12 14 7"/><polyline points="14 17 19 12"/></svg>
          </button>
        </div>
        <div class="pomo-notify">
          <div class="pomo-notify-lbl">Benachrichtigungen</div>
          <button class="ash-toggle" id="notify-toggle" onclick="toggleNotify()"></button>
        </div>
      </div>
      <div id="fokus-tasks"></div>
    </div>
  </div>

  <div class="panel" id="panel-aufgaben">
    <div id="aufg-filter" style="flex-shrink:0;display:flex;border-bottom:1px solid var(--w05);padding:0 4px;background:rgba(0,0,0,0.2);">
      <button class="tab on" id="filter-privat" style="flex:1;" onclick="setFilter('privat')">Privat</button>
      <button class="tab"    id="filter-arbeit" style="flex:1;" onclick="setFilter('arbeit')">Arbeit</button>
      <button class="tab"    id="filter-done"   style="flex:1;" onclick="setFilter('done')">Erledigt</button>
    </div>
    <div class="scroll" id="list-aufgaben"></div>
  </div>

  <div class="panel" id="panel-notizen">
    <div id="note-search-bar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="note-search" placeholder="Notiz suchen …" oninput="renderNotes()" autocomplete="off">
    </div>
    <div class="scroll" id="note-list"></div>
  </div>

</div><div id="fab-wrap">
  <div class="fab-item" id="fab-notiz">
    <span class="fab-lbl">Notiz</span>
    <button class="fab-ico" onclick="createNote();closeFab()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    </button>
  </div>
  <div class="fab-item" id="fab-arbeit">
    <span class="fab-lbl">Arbeit</span>
    <button class="fab-ico" onclick="openAddSheet('arbeit');closeFab()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
    </button>
  </div>
  <div class="fab-item" id="fab-privat">
    <span class="fab-lbl">Privat</span>
    <button class="fab-ico" onclick="openAddSheet('privat');closeFab()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    </button>
  </div>
  <button id="fab" onclick="toggleFab()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>
</div>

<div id="add-sheet-ov" onclick="if(event.target===this)closeAddSheet()">
  <div id="add-sheet">
    <div class="ash-handle"></div>
    <div class="ash-title" id="ash-title">Neue Aufgabe</div>
    <input id="ash-input" placeholder="Aufgabe tippen …" autocomplete="off"
           oninput="ashCheckWiki()" onkeydown="if(event.key==='Enter')submitAddSheet()">
    <div id="ash-ac"></div>
    <div class="ash-focus-toggle">
      <div class="ash-focus-label">Im Fokus</div>
      <button class="ash-toggle" id="ash-focus-toggle" onclick="toggleAshFocus()"></button>
    </div>
    <button class="ash-submit" onclick="submitAddSheet()">Hinzufügen</button>
  </div>
</div>

<div id="ed">
  <div id="ed-nav">
    <button id="ed-back" onclick="closeEd()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
      Zurück
    </button>
    <div id="ed-mode-toggle">
      <button class="ed-mode-btn" id="ed-btn-edit" onclick="setEdMode('edit')">Edit</button>
      <button class="ed-mode-btn on" id="ed-btn-prev" onclick="setEdMode('prev')">View</button>
    </div>
    <button id="ed-del" onclick="delNote()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
    </button>
  </div>
  <div id="ed-title-wrap">
    <input id="ed-title" type="text" placeholder="Titel eingeben …" oninput="onTitleInput(this.value)">
  </div>
  <div id="ed-tb">
    <button class="tbb" onclick="wrap('**','**')">B</button>
    <button class="tbb" style="font-style:italic" onclick="wrap('*','*')">I</button>
    <button class="tbb" onclick="wrap('`','`')">`</button>
    <div style="width:1px;height:16px;background:var(--w10);margin:0 4px;flex-shrink:0;"></div>
    <button class="tbb" onclick="insLine('# ')">H1</button>
    <button class="tbb" onclick="insLine('## ')">H2</button>
    <button class="tbb" onclick="insLine('- ')">•</button>
    <button class="tbb" onclick="insLine('> ')">»</button>
    <div style="width:1px;height:16px;background:var(--w10);margin:0 4px;flex-shrink:0;"></div>
    <button class="tbb" onclick="insWiki()">[[</button>
  </div>
  <div id="ed-body">
    <textarea id="ed-ta" placeholder="Schreibe etwas …"></textarea>
    <div id="ed-prev"></div>
  </div>
  <div id="ed-bl">
    <div class="bl-hd">Verknüpfte Notizen</div>
    <div id="ed-bl-list"></div>
  </div>
</div>

<div id="ac"><div id="ac-hd">Notiz verlinken</div><div id="ac-list"></div></div>

<div id="drv-ov" onclick="if(event.target===this)closeDrv()">
  <div id="drv-sh">
    <div class="ash-handle"></div>
    <div class="ash-title">Google Drive Sync</div>
    <div style="font-size:13px;color:var(--w40);line-height:1.6;margin-bottom:24px;">Cloud Console OAuth-ID konfigurieren, um Backups zu aktivieren.</div>
    <input id="ds-input" type="text" placeholder="xxxxxxxxx.apps.googleusercontent.com">
    <div class="sh-btns">
      <button class="sh-btn" onclick="closeDrv()">Abbrechen</button>
      <button class="sh-btn primary" onclick="connectDrive()">Verbinden</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ════════════════════════════════════════════════
   N·OS HIGH-END  ·  Tasks · Notes · Wiki · Pomo
════════════════════════════════════════════════ */
const CLIENT_ID='368244766898-da615t6bjr0q8lr0ujvqa362dd3c999q.apps.googleusercontent.com';
const DRV_SCOPE='https://www.googleapis.com/auth/drive.file';
const DRV_FILE='nothing_todos.json';
const LS_KEY='ntd_v6';

let S={todos:[],notes:{},tab:'fokus',filter:'privat',driveToken:null,driveFid:null,notify:false};
let P={sec:25*60,total:25*60,running:false,round:1,rounds:4,isBreak:false,iv:null};
let activeNote=null,edMode='prev',acActive=false,acSel=0,ashFocus=false,ashCat='privat',fabOpen=false;

// HAPTIC ENGINE
function hap(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

function save(){localStorage.setItem(LS_KEY,JSON.stringify({todos:S.todos,notes:S.notes,notify:S.notify}));schedDrv();}
function load(){
  try{
    const d=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    S.todos=d.todos||[]; S.notes=d.notes||{}; S.notify=d.notify||false;
    S.todos.forEach(t=>{if(!t.focus)t.focus=false;if(!t.links)t.links=[];});
  }catch(e){S.todos=[];S.notes={};}
}

let drvTimer=null;
function schedDrv(){if(!S.driveToken)return;clearTimeout(drvTimer);drvTimer=setTimeout(drvSave,3000);}
function syncDot(s){const d=document.getElementById('sync-dot');d.className=s==='on'?'on':s==='busy'?'busy':'';}

function autoConnect(){
  const stored=localStorage.getItem('drv_token');
  if(stored){S.driveToken=stored;drvLoad();return;}
  if(typeof google==='undefined'||!google.accounts){setTimeout(autoConnect,1500);return;}
  const client=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID,scope:DRV_SCOPE,
    callback:r=>{
      if(r.error)return;
      S.driveToken=r.access_token; localStorage.setItem('drv_token',r.access_token);
      syncDot('on');drvLoad();
    },
  });
  client.requestAccessToken({prompt:'none'});
}

function openDrv(){hap(10); document.getElementById('drv-ov').classList.add('on');}
function closeDrv(){document.getElementById('drv-ov').classList.remove('on');}
function connectDrive(){
  hap(15);
  const cid=document.getElementById('ds-input').value.trim()||CLIENT_ID;
  closeDrv();
  if(typeof google==='undefined'||!google.accounts){toast('Warte auf Google API…');setTimeout(connectDrive,1500);return;}
  const client=google.accounts.oauth2.initTokenClient({
    client_id:cid,scope:DRV_SCOPE,
    callback:r=>{
      if(r.error){toast('Fehler: '+r.error);return;}
      S.driveToken=r.access_token; localStorage.setItem('drv_token',r.access_token);
      syncDot('on');toast('Drive verbunden ✓');drvLoad();
    },
  });
  client.requestAccessToken({prompt:'select_account'});
}
async function drvLoad(){
  if(!S.driveToken)return;syncDot('busy');
  try{
    const r=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DRV_FILE}' and trashed=false&fields=files(id)`,{headers:{Authorization:'Bearer '+S.driveToken}});
    if(r.status===401){localStorage.removeItem('drv_token');S.driveToken=null;syncDot('');return;}
    const d=await r.json();
    if(d.files?.length){
      S.driveFid=d.files[0].id;
      const cr=await fetch(`https://www.googleapis.com/drive/v3/files/${S.driveFid}?alt=media`,{headers:{Authorization:'Bearer '+S.driveToken}});
      const cd=await cr.json();
      S.todos=cd.todos||S.todos;S.notes={...S.notes,...(cd.notes||{})};
      S.todos.forEach(t=>{if(!t.focus)t.focus=false;if(!t.links)t.links=[];});
      save();render();toast('Sync erfolgreich');
    }
    syncDot('on');
  }catch(e){syncDot('');}
}
async function drvSave(){
  if(!S.driveToken)return;syncDot('busy');
  const body=JSON.stringify({todos:S.todos,notes:S.notes});
  try{
    if(S.driveFid){
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${S.driveFid}?uploadType=media`,{method:'PATCH',headers:{Authorization:'Bearer '+S.driveToken,'Content-Type':'application/json'},body});
    }else{
      const m=await(await fetch('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{Authorization:'Bearer '+S.driveToken,'Content-Type':'application/json'},body:JSON.stringify({name:DRV_FILE})})).json();
      S.driveFid=m.id;
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${S.driveFid}?uploadType=media`,{method:'PATCH',headers:{Authorization:'Bearer '+S.driveToken,'Content-Type':'application/json'},body});
    }
    syncDot('on');
  }catch(e){syncDot('');}
}

function goTab(tab){
  if(S.tab!==tab) hap(10);
  S.tab=tab;
  document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.remove('on'));
  document.getElementById('tab-'+tab).classList.add('on');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
  document.getElementById('panel-'+tab).classList.add('on');
  render();
}
function setFilter(f){
  if(S.filter!==f) hap(10);
  S.filter=f;
  document.querySelectorAll('#aufg-filter .tab').forEach(b=>b.classList.remove('on'));
  document.getElementById('filter-'+f).classList.add('on');
  render();
}

function toggleFab(){hap(15); fabOpen=!fabOpen;document.getElementById('fab').classList.toggle('open',fabOpen);['privat','arbeit','notiz'].forEach(k=>document.getElementById('fab-'+k).classList.toggle('on',fabOpen));}
function closeFab(){if(fabOpen) hap(10); fabOpen=false;document.getElementById('fab').classList.remove('open');['privat','arbeit','notiz'].forEach(k=>document.getElementById('fab-'+k).classList.remove('on'));}
document.addEventListener('click',e=>{if(fabOpen&&!document.getElementById('fab-wrap').contains(e.target))closeFab();});

function openAddSheet(cat){
  ashCat=cat;ashFocus=false; hap(15);
  document.getElementById('ash-title').textContent='Neue '+cat+' Aufgabe';
  document.getElementById('ash-input').value='';
  document.getElementById('ash-focus-toggle').classList.remove('on');
  document.getElementById('ash-ac').innerHTML='';document.getElementById('ash-ac').classList.remove('on');
  document.getElementById('add-sheet-ov').classList.add('on');
  setTimeout(()=>document.getElementById('ash-input').focus(),100);
}
function closeAddSheet(){document.getElementById('add-sheet-ov').classList.remove('on');}
function toggleAshFocus(){hap(10); ashFocus=!ashFocus;document.getElementById('ash-focus-toggle').classList.toggle('on',ashFocus);}
function submitAddSheet(){
  const text=document.getElementById('ash-input').value.trim();
  if(!text)return; hap([15,30,15]);
  const links=[...(text.matchAll(/\[\[([^\]]+)\]\]/g))].map(m=>m[1]);
  links.forEach(t=>ensureNote(t));
  S.todos.unshift({id:uid(),text,cat:ashCat,done:false,focus:ashFocus,links,createdAt:Date.now()});
  save();render();closeAddSheet();
  toast('Hinzugefügt');
  goTab('aufgaben');setFilter(ashCat);
}

function ashCheckWiki(){
  const el=document.getElementById('ash-input'),v=el.value,pos=el.selectionStart,before=v.slice(0,pos);
  const closed=before.match(/\[\[([^\]\n]+)\]\]$/);
  if(closed){ensureNote(closed[1].trim());ashCloseAC();return;}
  const open=before.match(/\[\[([^\]\n]*)$/);
  if(open)ashShowAC(open[1]);else ashCloseAC();
}
function ashShowAC(q){
  const notes=allNotes().filter(n=>n.title.toLowerCase().includes(q.toLowerCase())).slice(0,6);
  const el=document.getElementById('ash-ac');
  if(!notes.length){el.classList.remove('on');return;}
  el.innerHTML=notes.map(n=>`<div class="ash-ac-row" onclick="ashSelect('${n.id}')">◈ ${esc(n.title)}</div>`).join('');
  el.classList.add('on');
}
function ashCloseAC(){document.getElementById('ash-ac').classList.remove('on');}
function ashSelect(id){
  hap(10);
  const n=S.notes[id];if(!n)return;
  const el=document.getElementById('ash-input'),pos=el.selectionStart,before=el.value.slice(0,pos);
  const m=before.match(/\[\[([^\]\n]*)$/);if(!m)return;
  const start=before.length-m[0].length,after=el.value.slice(pos).replace(/^\]\]/,'');
  el.value=el.value.slice(0,start)+'[['+n.title+']]'+after;
  const np=start+n.title.length+4;el.setSelectionRange(np,np);el.focus();
  ashCloseAC();ensureNote(n.title);
}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}
function toggleTodo(id){
  const t=S.todos.find(x=>x.id===id);if(!t)return;
  t.done=!t.done; 
  if(t.done) hap([20,50,20]); else hap(15);
  save();render();
}
function toggleFocusTodo(id,e){
  e.stopPropagation(); hap(15);
  const t=S.todos.find(x=>x.id===id);if(!t)return;
  t.focus=!t.focus;save();render();toast(t.focus?'Fokus an':'Fokus aus');
}
function delTodo(id,e){
  e.stopPropagation(); hap(20);
  if(!confirm('Endgültig löschen?'))return;
  S.todos=S.todos.filter(x=>x.id!==id);save();render();
}

const IC={
  check:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>`,
  foc:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4" fill="currentColor"/></svg>`,
  del:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
  rst:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>`,
};
function esc(s){const d=document.createElement('div');d.textContent=String(s||'');return d.innerHTML;}

function renderList(el,items,showCat=false){
  if(!items.length){el.innerHTML=`<div class="empty"><div class="empty-ring"></div><div class="empty-txt">Keine Einträge</div></div>`;return;}
  el.innerHTML=items.map(t=>`
    <div class="td${t.done?' done':''}" onclick="toggleTodo('${t.id}')">
      ${t.focus&&!t.done?'<div class="td-focus-dot"></div>':''}
      <div class="ck">${IC.check}</div>
      <div class="td-body">
        <div class="td-text">${renderTodoText(t.text)}</div>
        ${showCat?`<span class="cat-pill">${t.cat}</span>`:''}
      </div>
      <div class="td-btns">
        ${!t.done?`<button class="tb${t.focus?' foc-on':''}" onclick="toggleFocusTodo('${t.id}',event)">${IC.foc}</button>`:''}
        ${t.done?`<button class="tb" onclick="toggleTodo('${t.id}')">${IC.rst}</button>`:''}
        <button class="tb" onclick="delTodo('${t.id}',event)">${IC.del}</button>
      </div>
    </div>`).join('');
}
function renderTodoText(text){return esc(text).replace(/\[\[([^\]]+)\]\]/g,(_,t)=>`<span style="color:var(--red);font-weight:700;">[[${t}]]</span>`);}

const CIRC=2*Math.PI*82;
function pomoRender(){
  const m=Math.floor(P.sec/60).toString().padStart(2,'0'),s=(P.sec%60).toString().padStart(2,'0');
  document.getElementById('pomo-time').textContent=m+':'+s;
  document.getElementById('pomo-mode').textContent=P.isBreak?'PAUSE':'FOKUS';
  document.getElementById('pomo-arc').style.strokeDashoffset=CIRC*(1-P.sec/P.total);
  document.getElementById('pomo-rounds').innerHTML=Array.from({length:P.rounds},(_,i)=>`<div class="pr-dot${i<P.round-1?' done':''}"></div>`).join('');
  document.getElementById('ico-play').style.display=P.running?'none':'';
  document.getElementById('ico-pause').style.display=P.running?'':'none';
  document.getElementById('notify-toggle').classList.toggle('on',S.notify);
}
function toggleNotify(){
  hap(10); S.notify=!S.notify;save();
  if(S.notify&&'Notification' in window&&Notification.permission==='default'){Notification.requestPermission();}
  pomoRender();
}
function pomoToggle(){
  hap(20); P.running=!P.running;
  if(P.running){P.iv=setInterval(()=>{if(P.sec<=0){pomoNext();return;}P.sec--;pomoRender();},1000);}
  else clearInterval(P.iv);
  pomoRender();
}
function pomoNext(){
  clearInterval(P.iv);P.running=false;
  if(!P.isBreak){
    P.isBreak=true;const lg=P.round%P.rounds===0;
    P.total=P.sec=lg?15*60:5*60;
    const msg=lg?'Lange Pause — Gut gemacht!':'Kurze Pause';
    toast(msg); if(S.notify)sendNotify(msg);
  }else{
    P.isBreak=false;P.round=(P.round%P.rounds)+1;P.total=P.sec=25*60;
    const msg='Fokus-Zeit beginnt!';toast(msg);
    if(S.notify)sendNotify(msg);
  }
  hap([30,100,30,100,30]); pomoRender();
}
function pomoSkip(){hap(15); pomoNext();}
function pomoCycle(d){hap(10); clearInterval(P.iv);P.running=false;P.isBreak=false;P.round=Math.max(1,Math.min(P.rounds,P.round+d));P.total=P.sec=25*60;pomoRender();}
function sendNotify(msg){
  if(!('Notification' in window))return;
  if(Notification.permission==='granted'){new Notification('N·OS',{body:msg,icon:'icon-192x192.png',vibrate:[200,100,200]});}
}
function renderFokus(){
  const f=S.todos.filter(t=>t.focus&&!t.done);
  const dn=S.todos.filter(t=>t.focus&&t.done);
  const el=document.getElementById('fokus-tasks');
  if(!f.length&&!dn.length){
    el.innerHTML=`<div class="empty"><div class="empty-ring"></div><div class="empty-txt">Keine Aufgaben im Fokus<br>Tippe ◎ in der Aufgabenliste</div></div>`;
  }else{
    el.innerHTML=[...f,...dn].map(t=>`
      <div class="ftask${t.done?' done':''}" onclick="toggleTodo('${t.id}')">
        <div class="ck">${IC.check}</div>
        <div class="ftxt">${esc(t.text)}</div>
        <div class="fcat">${t.cat}</div>
      </div>`).join('');
  }
}

function allNotes(){return Object.values(S.notes).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));}
function createNote(title=''){
  hap(15);
  const id=uid();
  S.notes[id]={id,title:title||'Neue Notiz',content:'',updatedAt:Date.now()};
  save();openNote(id,!title);
  goTab('notizen');
}
function delNote(){
  if(!activeNote)return; hap(20);
  if(!confirm('Notiz endgültig löschen?'))return;
  delete S.notes[activeNote];save();closeEd();renderNotes();
}
function openNote(id,selTitle=false){
  hap(10);
  const n=S.notes[id];if(!n)return;
  activeNote=id;
  document.getElementById('ed-title').value=n.title;
  document.getElementById('ed-ta').value=n.content||'';
  setEdMode('prev');
  document.getElementById('ed').classList.add('open');
  updBL();
  if(selTitle){setEdMode('edit');setTimeout(()=>document.getElementById('ed-title').select(),100);}
}
function closeEd(){hap(10); flushNote();document.getElementById('ed').classList.remove('open');activeNote=null;renderNotes();}
function flushNote(){
  if(!activeNote)return;
  const n=S.notes[activeNote];if(!n)return;
  n.title=document.getElementById('ed-title').value.trim()||'Unbenannte Notiz';
  n.content=document.getElementById('ed-ta').value;
  n.updatedAt=Date.now();save();
}
function onTitleInput(v){if(!activeNote)return;S.notes[activeNote].title=v;S.notes[activeNote].updatedAt=Date.now();save();}

function setEdMode(mode){
  if(edMode!==mode) hap(10);
  edMode=mode;
  const prev=document.getElementById('ed-prev'),ta=document.getElementById('ed-ta');
  const btnEdit=document.getElementById('ed-btn-edit'),btnPrev=document.getElementById('ed-btn-prev');
  const tb=document.getElementById('ed-tb');
  if(mode==='prev'){
    flushNote();
    prev.innerHTML=parseMD(ta.value);
    prev.classList.add('on');ta.style.display='none';
    btnEdit.classList.remove('on');btnPrev.classList.add('on');
    tb.style.display='none';
  }else{
    prev.classList.remove('on');ta.style.display='';
    btnEdit.classList.add('on');btnPrev.classList.remove('on');
    tb.style.display='';
    ta.focus();
  }
}

function renderNotes(){
  const q=(document.getElementById('note-search')?.value||'').toLowerCase().trim();
  const el=document.getElementById('note-list');
  let notes=allNotes();
  if(q)notes=notes.filter(n=>(n.title+' '+n.content).toLowerCase().includes(q));
  if(!notes.length){el.innerHTML=`<div class="empty"><div class="empty-ring"></div><div class="empty-txt">${q?'Keine Treffer':'Noch keine Notizen'}</div></div>`;return;}
  el.innerHTML=notes.map(n=>{
    const prv=(n.content||'').replace(/#{1,6}\s/g,'').replace(/\*+/g,'').replace(/\[\[([^\]]+)\]\]/g,'$1').slice(0,80);
    return `<div class="note-row" onclick="openNote('${n.id}')"><div class="note-ttl">${esc(n.title)}</div>${prv?`<div class="note-prv">${esc(prv)}</div>`:''}<div class="note-dt">${n.updatedAt?fmtDate(n.updatedAt):''}</div></div>`;
  }).join('');
}

function parseMD(text){
  text=text.replace(/\[\[([^\]]+)\]\]/g,(_,t)=>{
    const ex=Object.values(S.notes).find(n=>n.title.toLowerCase()===t.toLowerCase());
    return `<a class="wl${ex?'':' new'}" data-nid="${ex?ex.id:''}" data-ntitle="${esc(t)}" onclick="wlClick(this)">${esc(t)}</a>`;
  });
  text=text.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  text=text.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  text=text.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  text=text.replace(/```([\s\S]*?)```/g,'<pre><code>$1</code></pre>');
  text=text.replace(/`([^`]+)`/g,'<code>$1</code>');
  text=text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  text=text.replace(/\*(.+?)\*/g,'<em>$1</em>');
  text=text.replace(/^---$/gm,'<hr>');
  text=text.replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>');
  text=text.replace(/^[-*] (.+)$/gm,'<li>$1</li>');
  text=text.replace(/^(\d+)\. (.+)$/gm,'<li>$2</li>');
  text=text.replace(/(<li>.*<\/li>\n?)+/gs,s=>'<ul>'+s+'</ul>');
  text=text.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');
  const lines=text.split('\n'),out=[];let inP=false;
  for(const l of lines){
    if(/^<(h[1-6]|ul|ol|pre|blockquote|hr|li)/.test(l)||l===''){if(inP){out.push('</p>');inP=false;}out.push(l);}
    else{if(!inP){out.push('<p>');inP=true;}out.push(l);}
  }
  if(inP)out.push('</p>');
  return out.join('\n');
}
function wlClick(el){hap(10); const id=el.dataset.nid,title=el.dataset.ntitle;if(id&&S.notes[id])openNote(id);else createNote(title);}
function updBL(){
  if(!activeNote)return;
  const cur=(S.notes[activeNote]?.title||'').toLowerCase();
  const linked=Object.values(S.notes).filter(n=>n.id!==activeNote&&[...(n.content||'').matchAll(/\[\[([^\]]+)\]\]/g)].some(m=>m[1].toLowerCase()===cur));
  const wrap=document.getElementById('ed-bl'),list=document.getElementById('ed-bl-list');
  if(!linked.length){wrap.classList.remove('on');return;}
  wrap.classList.add('on');
  list.innerHTML=linked.map(n=>`<div class="bl-row" onclick="openNote('${n.id}')">${esc(n.title)}</div>`).join('');
}

const ta=()=>document.getElementById('ed-ta');
function checkWiki(){
  const el=ta(),v=el.value,pos=el.selectionStart,before=v.slice(0,pos);
  const closed=before.match(/\[\[([^\]\n]+)\]\]$/);
  if(closed){ensureNote(closed[1].trim());closeAC();return;}
  const open=before.match(/\[\[([^\]\n]*)$/);
  if(open)showAC(open[1]);else closeAC();
}
function ensureNote(title){
  if(!Object.values(S.notes).some(n=>n.title.toLowerCase()===title.toLowerCase())){
    const id=uid();S.notes[id]={id,title,content:'',updatedAt:Date.now()};save();toast('«'+title+'» erstellt');
  }
}
function showAC(q){
  acActive=true;acSel=0;
  const notes=allNotes().filter(n=>n.id!==activeNote&&n.title.toLowerCase().includes(q.toLowerCase())).slice(0,8);
  const popup=document.getElementById('ac'),list=document.getElementById('ac-list');
  list.innerHTML=notes.map((n,i)=>`<div class="ac-row${i===0?' sel':''}" onclick="acSel_('${n.id}')">◈ ${esc(n.title)}</div>`).join('');
  if(!list.children.length){closeAC();return;}
  const r=ta().getBoundingClientRect();
  popup.style.left=Math.max(10,r.left+10)+'px';
  popup.style.top=Math.min(r.bottom-140,window.innerHeight-200)+'px';
  popup.classList.add('on');
}
function closeAC(){acActive=false;document.getElementById('ac').classList.remove('on');}
function acSel_(id){hap(10); const n=S.notes[id];if(!n)return;replaceWiki(n.title);}
function replaceWiki(title){
  const el=ta(),pos=el.selectionStart,before=el.value.slice(0,pos);
  const m=before.match(/\[\[([^\]\n]*)$/);if(!m)return closeAC();
  const start=before.length-m[0].length,after=el.value.slice(pos).replace(/^\]\]/,'');
  el.value=el.value.slice(0,start)+'[['+title+']]'+after;
  const np=start+title.length+4;el.setSelectionRange(np,np);el.focus();
  closeAC();ensureNote(title);flushNote();
}
function wrap(b,a){hap(10); const el=ta(),s=el.selectionStart,e=el.selectionEnd,sel=el.value.slice(s,e);el.setRangeText(b+sel+a,s,e,'end');el.focus();flushNote();}
function insLine(p){hap(10); const el=ta(),s=el.selectionStart,ls=el.value.lastIndexOf('\n',s-1)+1;el.setRangeText(p,ls,ls,'start');el.focus();flushNote();}
function insWiki(){hap(10); const el=ta(),s=el.selectionStart,e=el.selectionEnd,sel=el.value.slice(s,e);el.setRangeText('[['+sel+']]',s,e,'end');el.focus();showAC('');}

function render(){
  if(S.tab==='fokus'){renderFokus();pomoRender();}
  if(S.tab==='aufgaben'){
    const el=document.getElementById('list-aufgaben');
    if(S.filter==='done')renderList(el,S.todos.filter(t=>t.done),true);
    else renderList(el,S.todos.filter(t=>!t.done&&t.cat===S.filter));
  }
  if(S.tab==='notizen')renderNotes();
}

function toast(msg,ms=2200){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('on');clearTimeout(toast._t);toast._t=setTimeout(()=>el.classList.remove('on'),ms);}
function fmtDate(ts){const d=new Date(ts),now=new Date();if(d.toDateString()===now.toDateString())return d.toLocaleTimeString('de',{hour:'2-digit',minute:'2-digit'});return d.toLocaleDateString('de',{day:'2-digit',month:'2-digit'});}

document.addEventListener('keydown',e=>{
  if(document.getElementById('ed').classList.contains('open')){if(e.key==='Escape'){if(edMode==='edit')setEdMode('prev');else closeEd();}return;}
});
document.getElementById('ed-ta').addEventListener('input',()=>{flushNote();checkWiki();});
document.getElementById('ed-ta').addEventListener('keydown',e=>{
  if(!acActive)return;
  const items=document.querySelectorAll('.ac-row');
  if(e.key==='ArrowDown'){e.preventDefault();acSel=Math.min(acSel+1,items.length-1);items.forEach((el,i)=>el.classList.toggle('sel',i===acSel));}
  else if(e.key==='ArrowUp'){e.preventDefault();acSel=Math.max(acSel-1,0);items.forEach((el,i)=>el.classList.toggle('sel',i===acSel));}
  else if(e.key==='Enter'||e.key==='Tab'){e.preventDefault();const s=document.querySelector('.ac-row.sel');if(s)s.click();}
  else if(e.key==='Escape')closeAC();
});
document.getElementById('ed-ta').addEventListener('blur',()=>setTimeout(closeAC,200));
document.getElementById('ed-title').addEventListener('blur',flushNote);

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

load();render();pomoRender();
document.getElementById('ds-input').value=CLIENT_ID;
window.addEventListener('load',()=>setTimeout(autoConnect,2000));
</script>
</body>
</html>